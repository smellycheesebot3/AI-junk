<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>3D Kart Racer</title>
<style>
  body { margin: 0; overflow: hidden; background: #000; }
  #info {
    position: absolute; top: 10px; left: 10px;
    color: white; font-family: sans-serif; font-size: 14px;
    background: rgba(0,0,0,0.4); padding: 8px 12px; border-radius: 6px;
  }
</style>
</head>
<body>
<div id="info">WASD to drive • Space to brake</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>

<script>
// --------------------------------------------------
// Scene Setup
// --------------------------------------------------
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 2000);
camera.position.set(0, 5, -10);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

// --------------------------------------------------
// Lighting
// --------------------------------------------------
const sun = new THREE.DirectionalLight(0xffffff, 1.2);
sun.position.set(50, 100, -20);
sun.castShadow = true;
scene.add(sun);

scene.add(new THREE.AmbientLight(0xffffff, 0.4));

// --------------------------------------------------
// Ground
// --------------------------------------------------
const groundGeo = new THREE.PlaneGeometry(2000, 2000);
const groundMat = new THREE.MeshLambertMaterial({ color: 0x228833 });
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
ground.receiveShadow = true;
scene.add(ground);

// --------------------------------------------------
// Figure‑8 Track
// --------------------------------------------------
function createFigure8() {
  const curve = new THREE.CurvePath();

  const loop1 = new THREE.EllipseCurve(0, 20, 30, 15, 0, Math.PI*2, false);
  const loop2 = new THREE.EllipseCurve(0, -20, 30, 15, 0, Math.PI*2, false);

  curve.add(new THREE.CatmullRomCurve3(loop1.getSpacedPoints(50).map(p => new THREE.Vector3(p.x, 0, p.y))));
  curve.add(new THREE.CatmullRomCurve3(loop2.getSpacedPoints(50).map(p => new THREE.Vector3(p.x, 0, p.y))));

  const shape = new THREE.Shape();
  const w = 4;
  shape.moveTo(-w, -1);
  shape.lineTo(w, -1);
  shape.lineTo(w, 1);
  shape.lineTo(-w, 1);

  const extrude = new THREE.ExtrudeGeometry(shape, {
    steps: 200,
    bevelEnabled: false,
    extrudePath: curve
  });

  const mat = new THREE.MeshLambertMaterial({ color: 0x333333 });
  const mesh = new THREE.Mesh(extrude, mat);
  mesh.castShadow = true;
  mesh.receiveShadow = true;
  return { mesh, curve };
}

const { mesh: track, curve: trackCurve } = createFigure8();
scene.add(track);

// --------------------------------------------------
// Kart
// --------------------------------------------------
const kart = new THREE.Group();

// Body
const bodyGeo = new THREE.BoxGeometry(1.5, 0.6, 2.5);
const bodyMat = new THREE.MeshLambertMaterial({ color: 0xff3333 });
const body = new THREE.Mesh(bodyGeo, bodyMat);
body.castShadow = true;
kart.add(body);

// Wheels
function wheel(x, z) {
  const geo = new THREE.CylinderGeometry(0.4, 0.4, 0.3, 16);
  const mat = new THREE.MeshLambertMaterial({ color: 0x111111 });
  const w = new THREE.Mesh(geo, mat);
  w.rotation.z = Math.PI/2;
  w.position.set(x, -0.3, z);
  w.castShadow = true;
  return w;
}
kart.add(wheel(0.8, 1));
kart.add(wheel(-0.8, 1));
kart.add(wheel(0.8, -1));
kart.add(wheel(-0.8, -1));

kart.position.set(0, 0.5, 25);
scene.add(kart);

// --------------------------------------------------
// Controls
// --------------------------------------------------
const keys = {};
window.addEventListener("keydown", e => keys[e.code] = true);
window.addEventListener("keyup", e => keys[e.code] = false);

let speed = 0;
let angle = Math.PI;

// --------------------------------------------------
// Animation Loop
// --------------------------------------------------
function animate() {
  requestAnimationFrame(animate);

  // Movement
  const accel = 0.08;
  const maxSpeed = 1.2;
  const turnSpeed = 0.03;

  if (keys["KeyW"]) speed = Math.min(maxSpeed, speed + accel);
  if (keys["KeyS"]) speed = Math.max(-maxSpeed * 0.5, speed - accel);
  if (keys["Space"]) speed *= 0.85;

  speed *= 0.98; // friction

  if (keys["KeyA"]) angle += turnSpeed * (speed / maxSpeed);
  if (keys["KeyD"]) angle -= turnSpeed * (speed / maxSpeed);

  kart.position.x += Math.sin(angle) * speed;
  kart.position.z += Math.cos(angle) * speed;
  kart.rotation.y = angle;

  // Chase Camera
  const camOffset = new THREE.Vector3(0, 4, -8).applyAxisAngle(new THREE.Vector3(0,1,0), angle);
  camera.position.copy(kart.position).add(camOffset);
  camera.lookAt(kart.position);

  renderer.render(scene, camera);
}

animate();

// --------------------------------------------------
window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>
</body>
</html>
