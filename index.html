<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CodeChat – Chat by Room Code</title>
    <style>
        * { box-sizing: border-box; font-family: system-ui, sans-serif; }
        body {
            margin: 0;
            background: #111827;
            color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .app {
            background: #020617;
            border-radius: 10px;
            width: 900px;
            max-width: 95vw;
            height: 520px;
            display: flex;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
            border: 1px solid #1f2937;
        }
        .sidebar {
            width: 260px;
            border-right: 1px solid #1f2937;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
        }
        .sidebar h1 {
            font-size: 22px;
            margin: 0 0 4px;
        }
        .sidebar p {
            font-size: 13px;
            margin: 0;
            color: #9ca3af;
        }
        .label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #9ca3af;
        }
        .input-row {
            display: flex;
            gap: 6px;
            margin-top: 4px;
        }
        input[type="text"] {
            background: #020617;
            border-radius: 6px;
            border: 1px solid #374151;
            padding: 6px 8px;
            color: #f9fafb;
            font-size: 14px;
            width: 100%;
            outline: none;
        }
        input[type="text"]:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        button {
            border-radius: 6px;
            border: none;
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
            background: #2563eb;
            color: #f9fafb;
            white-space: nowrap;
        }
        button.secondary {
            background: #111827;
            border: 1px solid #374151;
            color: #e5e7eb;
        }
        button:disabled {
            opacity: 0.5;
            cursor: default;
        }
        .status-box {
            margin-top: 10px;
            border-radius: 6px;
            border: 1px solid #1f2937;
            padding: 8px;
            background: #020617;
            font-size: 13px;
        }
        .status-label {
            font-weight: 600;
            color: #9ca3af;
        }
        .status-value {
            color: #f9fafb;
        }
        .hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 10px;
            line-height: 1.4;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            border-bottom: 1px solid #1f2937;
            padding: 12px 16px;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
        }
        .chat-header-title {
            font-size: 16px;
            font-weight: 600;
        }
        .chat-header-room {
            font-size: 13px;
            color: #9ca3af;
        }
        .chat-header-user {
            font-size: 13px;
            color: #6b7280;
        }

        .messages {
            flex: 1;
            padding: 12px 16px 0;
            overflow-y: auto;
            background: radial-gradient(circle at top, #020617 0, #020617 40%, #020617 80%);
        }
        .message {
            margin-bottom: 8px;
            max-width: 70%;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.4;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .message.self {
            margin-left: auto;
            background: #1d4ed8;
        }
        .message.other {
            background: #111827;
            border: 1px solid #1f2937;
        }
        .message-meta {
            font-size: 11px;
            color: #9ca3af;
            margin-bottom: 2px;
        }
        .message-self-meta {
            text-align: right;
        }

        .system {
            text-align: center;
            font-size: 11px;
            color: #6b7280;
            margin: 6px 0;
        }

        .chat-input-row {
            border-top: 1px solid #1f2937;
            padding: 10px 12px;
            display: flex;
            gap: 8px;
            background: #020617;
        }
        .chat-input-row input[type="text"] {
            background: #020617;
        }
        .chat-input-row button {
            padding: 8px 14px;
        }

        .disabled-overlay {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top, rgba(15,23,42,0.7), rgba(15,23,42,0.95));
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        .disabled-overlay.active {
            display: flex;
        }
        .disabled-overlay-inner {
            max-width: 320px;
            color: #e5e7eb;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
<div class="app">
    <div class="sidebar">
        <div>
            <h1>CodeChat</h1>
            <p>Join a chat room by entering the same code as your friends.</p>
        </div>

        <div>
            <div class="label">Your name</div>
            <input type="text" id="usernameInput" placeholder="e.g. Alex" maxlength="20">
        </div>

        <div>
            <div class="label">Room code</div>
            <div class="input-row">
                <input type="text" id="roomInput" placeholder="e.g. MATH-ROOM" maxlength="20">
                <button id="joinBtn">Join</button>
            </div>
            <button id="leaveBtn" class="secondary" style="margin-top:6px;" disabled>Leave</button>
        </div>

        <div class="status-box">
            <div class="status-label">Status</div>
            <div class="status-value" id="statusText">Not in a room</div>
        </div>

        <div class="hint">
            Open this page in another tab or browser, type the
            <strong>same room code</strong> and you can chat using local storage.
        </div>
    </div>

    <div class="main">
        <div class="chat-header">
            <div>
                <div class="chat-header-title">Room</div>
                <div class="chat-header-room" id="roomNameLabel">None</div>
            </div>
            <div class="chat-header-user" id="userLabel">You: (not set)</div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="chat-input-row">
            <input type="text" id="messageInput" placeholder="Type your message..." maxlength="500" disabled>
            <button id="sendBtn" disabled>Send</button>
        </div>

        <div class="disabled-overlay" id="overlay">
            <div class="disabled-overlay-inner">
                Enter a <strong>name</strong> and a <strong>room code</strong> on the left, then click <strong>Join</strong> to start chatting.
            </div>
        </div>
    </div>
</div>

<script>
(function () {
    const usernameInput = document.getElementById('usernameInput');
    const roomInput = document.getElementById('roomInput');
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const statusText = document.getElementById('statusText');
    const roomNameLabel = document.getElementById('roomNameLabel');
    const userLabel = document.getElementById('userLabel');
    const messagesEl = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const overlay = document.getElementById('overlay');

    let currentRoom = null;
    let username = '';

    function normalizeCode(code) {
        return code.trim().toUpperCase().replace(/\s+/g, '-');
    }

    function getRoomKey(code) {
        return 'codechat-room-' + code;
    }

    function loadRoomMessages(code) {
        const json = localStorage.getItem(getRoomKey(code));
        if (!json) return [];
        try {
            return JSON.parse(json);
        } catch {
            return [];
        }
    }

    function saveRoomMessages(code, messages) {
        localStorage.setItem(getRoomKey(code), JSON.stringify(messages));
    }

    function appendMessageToUI(msg, isSelf) {
        const wrapper = document.createElement('div');
        if (msg.type === 'system') {
            wrapper.className = 'system';
            wrapper.textContent = msg.text;
            messagesEl.appendChild(wrapper);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            return;
        }

        wrapper.className = 'message ' + (isSelf ? 'self' : 'other');

        const meta = document.createElement('div');
        meta.className = 'message-meta ' + (isSelf ? 'message-self-meta' : '');
        meta.textContent = `${msg.sender} • ${msg.time}`;
        const text = document.createElement('div');
        text.textContent = msg.text;

        wrapper.appendChild(meta);
        wrapper.appendChild(text);
        messagesEl.appendChild(wrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderRoomHistory(code) {
        messagesEl.innerHTML = '';
        const msgs = loadRoomMessages(code);
        msgs.forEach(m => appendMessageToUI(m, m.sender === username));
    }

    function addSystemMessage(code, text) {
        const msgs = loadRoomMessages(code);
        const msg = {
            type: 'system',
            text,
            time: new Date().toLocaleTimeString()
        };
        msgs.push(msg);
        saveRoomMessages(code, msgs);
        // Trigger storage event in other tabs
        localStorage.setItem('codechat-last-update', Date.now().toString());
        appendMessageToUI(msg, false);
    }

    function sendChatMessage() {
        if (!currentRoom) return;
        const text = messageInput.value.trim();
        if (!text) return;

        const msgs = loadRoomMessages(currentRoom);
        const msg = {
            type: 'user',
            sender: username,
            text,
            time: new Date().toLocaleTimeString()
        };
        msgs.push(msg);
        saveRoomMessages(currentRoom, msgs);
        // notify other tabs
        localStorage.setItem('codechat-last-update', Date.now().toString());
        appendMessageToUI(msg, true);
        messageInput.value = '';
    }

    function joinRoom() {
        const nameVal = usernameInput.value.trim();
        let roomVal = roomInput.value;
        if (!nameVal || !roomVal) return;

        username = nameVal;
        roomVal = normalizeCode(roomVal);
        currentRoom = roomVal;

        usernameInput.disabled = true;
        roomInput.disabled = true;
        joinBtn.disabled = true;
        leaveBtn.disabled = false;
        messageInput.disabled = false;
        sendBtn.disabled = false;
        overlay.classList.remove('active');

        statusText.textContent = 'In room ' + roomVal;
        roomNameLabel.textContent = roomVal;
        userLabel.textContent = 'You: ' + username;

        renderRoomHistory(roomVal);
        addSystemMessage(roomVal, username + ' joined the room');
    }

    function leaveRoom() {
        if (!currentRoom) return;
        addSystemMessage(currentRoom, username + ' left the room');

        currentRoom = null;
        usernameInput.disabled = false;
        roomInput.disabled = false;
        joinBtn.disabled = false;
        leaveBtn.disabled = true;
        messageInput.disabled = true;
        sendBtn.disabled = true;
        overlay.classList.add('active');

        statusText.textContent = 'Not in a room';
        roomNameLabel.textContent = 'None';
        userLabel.textContent = 'You: (not set)';
        messagesEl.innerHTML = '';
    }

    // Events
    joinBtn.addEventListener('click', joinRoom);
    leaveBtn.addEventListener('click', leaveRoom);

    roomInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') joinRoom();
    });
    usernameInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') joinRoom();
    });
    messageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendChatMessage();
        }
    });
    sendBtn.addEventListener('click', sendChatMessage);

    // Listen for changes from other tabs
    window.addEventListener('storage', e => {
        if (!currentRoom) return;
        if (e.key === getRoomKey(currentRoom) || e.key === 'codechat-last-update') {
            const msgs = loadRoomMessages(currentRoom);
            messagesEl.innerHTML = '';
            msgs.forEach(m => appendMessageToUI(m, m.sender === username));
        }
    });

    // Initial overlay
    overlay.classList.add('active');
})();
</script>
</body>
</html>
